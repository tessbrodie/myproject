---
title: "PKM2"
date: "`r format(Sys.Date())`"
author: Tess Brodie
output: 
   html_document:
    toc_depth: 2
---

## Introduction

```{r setup, include = FALSE, dev='svg'}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(autodep = TRUE, cache = TRUE, cache.lazy = FALSE)
knitr::opts_chunk$set(dev = 'svg')
```



### Load packages

```{r load-libs, message = FALSE, warning = FALSE}
library(CATALYST)
library(dplyr)
library(flowCore)
library(ggplot2)
library(diffcyt)
library(cowplot)
library(viridis)
library(RColorBrewer)
library(workflowr)
```

### Load data

```{r load-data}
sce <- readRDS(file.path("output", "sce.rds"))
```

## Liver subsets with PKM2 expression over time

```{r}
plotMultiHeatmap(sce, 
                 k = "mm", scale = "first",
                 hm1 = "type", hm2 = "PKM2",
                 row_anno = FALSE, col_clust = FALSE,
                 row_clust = FALSE, col_anno = FALSE,
                 bars = TRUE, perc = TRUE,
                 hm2_pal = hcl.colors(3, palette = "viridis"))

```

### Liver subsets with Unknown population taken out for better heatmap visualization

```{r}
sceU <- filterSCE(sce, k = "mm",
               cluster_id %in% c("B cells","BMDM", "cDCs",
                                 "Granulocytes","Hepatocytes", "KCs", "LSECs",
                                 "pDCs", "T cells"))
plotMultiHeatmap(sceU, 
                 k = "mm", scale = "first",
                 hm1 = "type", hm2 = "PKM2",
                 row_anno = FALSE, col_clust = FALSE,
                 row_clust = FALSE, col_anno = FALSE,
                 bars = TRUE, perc = TRUE,
                 hm2_pal = hcl.colors(3, palette = "viridis"))

```
### Another color combo

```{r}
plotMultiHeatmap(sceU, 
                 k = "mm", scale = "first",
                 hm1 = "type", hm2 = "PKM2",
                 row_anno = FALSE, col_clust = FALSE,
                 row_clust = FALSE, col_anno = FALSE,
                 bars = TRUE, perc = TRUE,
                 hm2_pal = hcl.colors(12, palette = "Plasma"))
```
### Another color combo

```{r}
plotMultiHeatmap(sceU, 
                 k = "mm", scale = "first",
                 hm1 = "type", hm2 = "PKM2",
                 row_anno = FALSE, col_clust = FALSE,
                 row_clust = FALSE, col_anno = FALSE,
                 bars = TRUE, perc = TRUE,
                 hm2_pal = hcl.colors(12, palette = "Inferno"))
```



## Differential State analysis on BMDM
We see that the BMDM have increasing amounts of PKM2 over time after PhX and we want to see if the increase in PKM2 expression is associated with other significant phenotypic changes in this subset. 

```{r}
# create design matrix
design <- createDesignMatrix(ei(sce), "condition")
colnames(design) <- gsub("condition", "", colnames(design))

# run DS analysis for control vs. each timepoint
for (i in colnames(design)[-1]) {
  # create contrast matrix
  contrast <- createContrast(as.numeric(colnames(design) == i))
    
  # run DS analysis & extract results table
  res_DS <- diffcyt(sce, clustering_to_use = "mm",
                  analysis_type = "DS", method_DS = "diffcyt-DS-limma",
                  design = design, contrast = contrast, verbose = FALSE)

  # extract results table
  tbl_DS <- rowData(res_DS$res)
  
   # include all results for selected cluster
  k <- metadata(res_DS$res)$clustering_name
  sub1 <- filterSCE(sce, cluster_id == "BMDM", k = k)
  
  sub1
  

  # write table to .csv
    fn <- file.path("output", sprintf("DS-results_%s.csv", i))
    write.csv(tbl_DS, fn, row.names = FALSE)
    

   # subset control and timepoint of interest
    sub <- filterSCE(sub1, condition %in% c("control", !!i))
    
    
  # plot differential heatmap
    p <- plotDiffHeatmap(sub, tbl_DS, all = TRUE, col_anno = "condition")
    cat("## ", i, "\n"); print(p); cat("\n\n")
} 
```
### Plot all timepoints and significant changes in BMDM
This needs editing because now it is showing all timepoints, but the significance shown is for control vs 48 hours.  It is very tricky to show the p values for each condition in one graph... I'm not sure how that could be done.  Maybe the heatmap of the target expression over time and the fold change is enough and we could report the P values for each timepoint in a table?  Or we compare the control to all the other conditions globally... This is to be discussed.
```{r}
# create design matrix
design <- createDesignMatrix(ei(sce), "condition")
colnames(design) <- gsub("condition", "", colnames(design))

# run DS analysis for control vs. each timepoint
for (i in colnames(design)[-1]) 
  # create contrast matrix
  contrast <- createContrast(as.numeric(colnames(design) == i))
    
  # run DS analysis & extract results table
  res_DS <- diffcyt(sce, clustering_to_use = "mm",
                  analysis_type = "DS", method_DS = "diffcyt-DS-limma",
                  design = design, contrast = contrast, verbose = FALSE)

  # extract results table
  tbl_DS <- rowData(res_DS$res)
  
   # include all results for selected cluster
  k <- metadata(res_DS$res)$clustering_name
  sub2 <- filterSCE(sce, cluster_id == "BMDM", k = k)
  
  sub2
  

  # write table to .csv (doesnt work here)
    fn <- file.path("output", sprintf("DS-results_%s.csv", i))
    write.csv(tbl_DS, fn, row.names = FALSE)
    
    
  # plot differential heatmap
    p <- plotDiffHeatmap(sub2, tbl_DS, all = TRUE, col_anno = "condition")
    cat("## ", i, "\n"); print(p); cat("\n\n")
 
```







### Filter on BMDM 

```{r}
sceB <- filterSCE(sce, k = "mm",
               cluster_id %in% "BMDM")

plot_grid(
  plotDR(sce, dr= "TSNE", color_by = "mm"),
  plotDR(sceB, dr= "TSNE", color_by = "mm"))
```
## Plot BMDM targets that change significantly over time
This plot didn't really work out...  too big and bulky

```{r}
plotMultiHeatmap(sceB, 
    k = "mm", scale = "never",
    hm1 = FALSE, hm2 = c("PKM2", "CD161"),
    row_anno = FALSE, col_clust = FALSE, col_anno = FALSE,
    hm2_pal = hcl.colors(10, palette = "viridis"))
```


### Target expression in BMDM
This is a global overview of the BMDM target expression over time (quality control)

```{r}
plotExprHeatmap(sceB,
    row_anno = FALSE,   # don't annotate samples
    row_clust = FALSE,  # keep samples in original order
    col_clust = FALSE,  # keep markers in original order
    bin_anno = FALSE,   # don't annotate bins
    bars = FALSE,       # don't include sample sizes
    scale = "last",     # aggregate, then scale
    hm_pal = hcl.colors(10, "YlGnBu", rev = TRUE))


```





## tSNE with targets that identify the subsets and PKM2
We would like to show how the subsets were identified and show the differential expression of PKM2 in hepatocytes

```{r}
p <- plotDR(sce, dr = "TSNE", color_by = c("CD45","Gata6", "F4_80", "CD11b", "PKM2"))
p$facet$params$ncol <- 3; p
```

## Hepatocytes and differential expression of PKM2
*need help scaling second tsne plot

```{r}
sceH <- filterSCE(sce, k = "mm",
               cluster_id %in% "Hepatocytes")

plot_grid(
  plotDR(sce, dr= "TSNE", color_by = "mm"),
  plotDR(sceH, dr= "TSNE", color_by = "mm"))
```

## tSNE of hepatocytes

```{r}
sceH <- runDR(sceH, dr = "TSNE", features = NULL)
plotDR(sceH, dr = "TSNE", color_by = "PKM2")

```

## Proportion of hepatocytes per sample

```{r}
plotCounts(sceH, 
           prop = TRUE,
           group_by = "condition", 
           color_by = "patient_id")
```

## Number of hepatocytes per sample

```{r}
plotCounts(sceH, 
           group_by = "sample_id", 
           color_by = "condition")

```

## Hepatocyte subsets and PKM2 over time
We don't see one subset with all the PKM2

```{r}
sceH <- cluster(sceH, 
                xdim = 10, ydim = 10, maxK = 3, 
                verbose = FALSE)

plotMultiHeatmap(sceH, 
                 hm1 = "type", hm2 = "PKM2", 
                 k = "meta3", row_anno = FALSE,
                 col_dend = c(FALSE, TRUE))
```

### tSNE plot of hepatocyte subsets 

```{r}
plotDR(sceH, dr = "TSNE", color_by = "meta3")
```


### Cluster hepatocytes into many clusters to get a cluster with the PKM2 high cells in it
We still don't see one subset with all the PKM2

```{r}
sceH <- cluster(sceH, 
                xdim = 10, ydim = 10, maxK = 15, 
                verbose = FALSE)

plotMultiHeatmap(sceH, 
                 hm1 = "type", hm2 = "PKM2", 
                 k = "meta15", row_anno = FALSE,
                 col_dend = c(FALSE, TRUE))


```

### Plot clusters on tSNE

```{r}
plotDR(sceH, dr = "TSNE", color_by = "meta15")
```

